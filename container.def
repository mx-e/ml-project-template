Bootstrap: docker
From: python:3.12-slim

%files
    pyproject.toml /pyproject.toml
    uv.lock /uv.lock
    README.md /README.md

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PYTHONPATH=./src:$PYTHONPATH
    export UV_LINK_MODE=copy

%post   
    apt update && apt install openssh-client -y
    pip install --root-user-action=ignore --no-cache-dir uv
    uv sync --frozen --no-dev --no-install-project

    # install aliases for the slurm commands
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sacct $1' >> /usr/local/bin/sacct
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sacctmgr $1' >> /usr/local/bin/sacctmgr
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME salloc $1' >> /usr/local/bin/salloc
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sattach $1' >> /usr/local/bin/sattach
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sbatch $1' >> /usr/local/bin/sbatch
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sbcast $1' >> /usr/local/bin/sbcast
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME scancel $1' >> /usr/local/bin/scancel
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME scontrol $1' >> /usr/local/bin/scontrol
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sdiag $1' >> /usr/local/bin/sdiag
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sgather $1' >> /usr/local/bin/sgather
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sinfo $1' >> /usr/local/bin/sinfo
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME smap $1' >> /usr/local/bin/smap
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sprio $1' >> /usr/local/bin/sprio
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME squeue $1' >> /usr/local/bin/squeue
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sreport $1' >> /usr/local/bin/sreport
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME srun $1' >> /usr/local/bin/srun
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sshare $1' >> /usr/local/bin/sshare
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sstat $1' >> /usr/local/bin/sstat
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME strigger $1' >> /usr/local/bin/strigger
    echo '#!/bin/bash \n ssh $USER@$HOSTNAME sview $1' >> /usr/local/bin/sview
    cd /usr/local/bin
    chmod 755 sacct salloc sbatch scancel sdiag sinfo sprio sreport sshare strigger sacctmgr sattach sbcast scontrol sgather smap squeue srun sstat sview